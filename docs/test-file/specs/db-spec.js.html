<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">specs/db-spec.js | px-mobile.js API API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="git+https://github.com/jonniespratley/px-mobilejs.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/base.js~BaseClass.html">BaseClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pxMobile">pxMobile</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/x-module.js~xModule.html">xModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">core</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/plugins.js~Plugins.html">Plugins</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/pubsub.js~PubSub.html">PubSub</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/router-history.js~RouterHistory.html">RouterHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/service-locator.js~ServiceLocator.html">ServiceLocator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/simple-router.js~SimpleRouter.html">SimpleRouter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ds</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/collection.js~Collection.html">Collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/db.js~DB.html">DB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/http.js~HTTP.html">HTTP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">elements</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/elements/pm-page.js~pmPage.html">pmPage</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ui</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/app.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/element.js~Element.html">Element</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/elements.js~Elements.html">Elements</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/page.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/pages.js~Pages.html">Pages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/view.js~View.html">View</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/views.js~Views.html">Views</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/dom.js~DOM.html">DOM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/interface.js~Interface.html">Interface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/log.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dom">dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addMixin">addMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-debounce">debounce</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extend">extend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendClass">extendClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendDeep">extendDeep</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mix">mix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mixin">mixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resolveURL">resolveURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-type">type</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-uuid">uuid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$">$</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Interfaces">Interfaces</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aggregation">aggregation</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">specs/db-spec.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content"> function PouchDbAdapter(name, options) {
   // TODO: PouchDB Adapter
   PouchDB.debug(&apos;*&apos;);
   var _db = new PouchDB(name, options);

   var adapter = {
     parseJSON: function(resp) {
       console.log(&apos;Pouchdb response&apos;, resp);
       return {
         status: &apos;ok&apos;,
         data: resp
       };
     },
     get: function(url, args) {
       return _db.get(args).then(this.parseJSON);
     },
     put: function(url, args) {
       return _db.get(args).then(this.parseJSON);
     },
     info: function() {
       return _db.info().then(this.parseJSON);
     }
   };


   return adapter;



 }

 var DATABASE_URL = &apos;http://localhost:5984/default&apos;;
 var TEST_IDS = [];

 /** @test {DB} */
 describe(&apos;pxMobile.DB&apos;, function() {



   var sandbox = sinon.sandbox;
   var db = null,
     testAttachmentDoc = &apos;test-doc-attachment-&apos; + Date.now(),
     successCallback, errorCallback,
     testObj = {
       _id: &apos;test-&apos; + Date.now(),
       title: &apos;Test Doc&apos;
     },
     docs = [{
       _id: &apos;test-doc-1-&apos; + Date.now(),
       name: &apos;Test Doc 1&apos;
    }, {
       _id: &apos;test-doc-2-&apos; + Date.now(),
       name: &apos;Test Doc 2&apos;
    }, {
       _id: &apos;test-doc-3-&apos; + Date.now(),
       name: &apos;Test Doc 3&apos;
    }];

   before(function() {
     sandbox.useFakeServer();
     this.server = sinon.fakeServer.create();
     db = db = new pxMobile.DB(&apos;testdb&apos;, {
       baseUrl: DATABASE_URL
     });
   });


   it(&apos;should be defined&apos;, function() {
     assert.ok(pxMobile.DB);
   });

   it(&apos;should have methods: allDocs, get, put, post, remove, bulkDocs, getAttachment, saveAttachment&apos;, function(done) {
     assert.ok(db.allDocs);
     assert.ok(db.get);
     assert.ok(db.post);
     assert.ok(db.put);
     assert.ok(db.remove);
     assert.ok(db.getAttachment);
     assert.ok(db.saveAttachment);
     done();
   });


   xdescribe(&apos;Adapter&apos;, function() {

     var mockPromise = function(resp, time) {
       return new Promise(function(resolve, reject) {
         return setTimeout(function() {
           return resolve(resp);
         }, time || 100);
       });
     };

     var mockAdapter = function(name, options) {
       return {
         get: mockPromise(sinon.spy()),
         put: mockPromise(sinon.spy()),
         post: sinon.spy(),
         delete: sinon.spy(),
         request: sinon.spy(),
         allDocs: sinon.spy()
       };
     };


     it(&apos;should be able to use an adapter&apos;, function() {
       var localDb = localDb = new pxMobile.DB(&apos;localDb&apos;, {
         baseUrl: DATABASE_URL || &apos;/default&apos;,
         adapter: new mockAdapter(&apos;test&apos;, {})
       });

       localDb.get(&apos;test&apos;);
       localDb.put({
         _id: &apos;test&apos;
       });
       localDb.post({
         name: &apos;test 3&apos;
       });
       localDb.allDocs({
         include_docs: true
       });
       assert.ok(localDb.adapter.get.called);
       assert.ok(localDb.adapter.put.called);
       assert.ok(localDb.adapter.post.called);
       assert.ok(localDb.adapter.allDocs.called);
     });
   });

   /** @test {DB#info} */
   it(&apos;info() - should resolve promise on success with database info&apos;, function(done) {
     db.info().then(function(resp) {
       assert.equal(resp.status, 200);
       assert.ok(resp.data);
       assert.ok(resp.data.db_name);
       assert.ok(resp.data.update_seq);

       done();
     }, failSpec);
   });

   /** @test {DB#bulkDocs} */
   it(&apos;bulkDocs(docs) - should resolve promise on success&apos;, function(done) {
     db.bulkDocs(docs).then(function(resp) {
       docs = resp.data;
       assert.equal(resp.status, 201);
       assert.equal(resp.data.length, 3);

       done();
     }, failSpec);
   });

   /** @test {DB#bulkDocs} */
   it(&apos;bulkDocs(docs) - should remove doc if _delete flag is set&apos;, function(done) {
     docs.forEach(function(doc) {
       if (doc._rev) {
         doc._deleted = true;
       }
     });
     db.bulkDocs(docs).then(function(resp) {
       docs = resp.data;
       assert.equal(resp.status, 201);
       assert.equal(resp.data.length, 3);
       done();
     }, failSpec);
   });

   /** @test {DB#allDocs} */
   it(&apos;allDocs(options) - should resolve promise on success&apos;, function(done) {
     db.allDocs({
       limit: 5
     }).then(function(resp) {
       assert.equal(resp.status, 200);
       assert.ok(resp.data.rows);
       assert.equal(resp.data.rows.length, 5);
       done();
     }, failSpec);
   });

   /** @test {DB#put} */
   it(&apos;put(doc) - should resolve promise on success&apos;, function(done) {
     db.put(testObj).then(function(resp) {
       assert.equal(resp.status, 201);
       assert.ok(resp.data.rev);
       done();
     });
   });

   /** @test {DB#get} */
   it(&apos;get(id) - should resolve promise on success&apos;, function(done) {
     db.get(testObj._id).then(function(resp) {
       assert.equal(resp.status, 200);
       assert.ok(resp.data._rev);
       done();
     }, failSpec);
   });

   /** @test {DB#get} */
   it(&apos;get(id) - should reject promise on error&apos;, function(done) {
     db.get(&apos;unknown-id&apos;).then(function(resp) {
       assert.equal(resp.status, 404);
       done();
     }).catch(function(resp) {
       assert.equal(resp.status, 404);
     });
   });

   /** @test {DB#remove} */
   it(&apos;remove(id, rev) - should resolve promise on success&apos;, function(done) {
     db.get(testObj._id).then(function(resp) {
       testObj._rev = resp.data._rev;
       db.remove(testObj._id, testObj._rev).then(function(res) {
         assert.equal(res.status, 200);
         done();
       }, failSpec);
     });
   });

   var newDocId = &apos;&apos;;
   /** @test {DB#post} */
   it(&apos;post(doc) - should insert document with generated id and resolve promise on success.&apos;, function(done) {
     db.post({
       title: &apos;New Doc&apos;
     }).then(function(resp) {
       assert.equal(resp.status, 201);
       assert.ok(resp.data.id);
       assert.ok(resp.data.rev);
       db.remove(resp.data.id, resp.data.rev).then(function(res) {
         assert.equal(res.status, 200);
         done();
       }, failSpec);
     }, failSpec);
   });


   /** @test {DB#saveAttachment} */
   it(&apos;saveAttachment(id, rev, filename, type, file) - should save file attachment&apos;,
     function(done) {
       var aFileParts = [&apos;&lt;a id=&quot;a&quot;&gt;&lt;b id=&quot;b&quot;&gt;hey!&lt;/b&gt;&lt;/a&gt;&apos;];
       var myBlob = new Blob(aFileParts, {
         type: &apos;text/html&apos;
       });
       db.put({
         _id: testAttachmentDoc
       }).then(function(resp) {
         assert.equal(resp.ok, true);
         db.get(testAttachmentDoc).then(function(resp) {
           assert.equal(resp.ok, true);
           db.saveAttachment(resp.data._id, resp.data._rev, &apos;file.html&apos;, myBlob.type,
             myBlob).then(function(resp) {
             assert.equal(resp.ok, true);
             done();
           }, failSpec);
         }, failSpec);
       }, failSpec);

     });

   /** @test {DB#getAttachment} */
   it(&apos;getAttachment(id, filename) - should return file attachment&apos;, function(done) {
     db.getAttachment(testAttachmentDoc, &apos;file.html&apos;).then(function(resp) {
       assert.equal(resp.ok, true);
       db.get(testAttachmentDoc).then(function(res) {
         assert.equal(res.ok, true);
         db.remove(res.data._id, res.data._rev).then(function(re) {
           assert.equal(re.status, 200);
           done();
         }, failSpec);
       }, failSpec);
     }, failSpec);
   });


   describe(&apos;Changes&apos;, function() {
     var changes, changeHandlers = {};

     beforeEach(function() {

       //jasmine.clock().install();
     });

     afterEach(function() {
       //jasmine.clock().uninstall();
       //  changes.cancel();
     });

     /** @test {DB#changes} */
     it(&apos;changes() - should request changes and invoke callbacks on events&apos;, function(done) {
       changeHandlers.changeHandler = sinon.spy();
       changeHandlers.completeHandler = sinon.spy();
       changeHandlers.errorHandler = sinon.spy();
       changes = db.changes({
           since: &apos;now&apos;,
           live: true,
           interval: 100,
           include_docs: true
         })
         .on(&apos;change&apos;, changeHandlers.changeHandler)
         .on(&apos;complete&apos;, changeHandlers.completeHandler)
         .on(&apos;error&apos;, changeHandlers.errorHandler);

       //assert.ok(changeHandlers.changeHandler).not.toHaveBeenCalled();

       setTimeout(function() {
         console.warn(changeHandlers.changeHandler);
         assert.ok(changeHandlers.changeHandler);
         changes.cancel();
         done();
       }, 100);
     });

   });



   describe(&apos;Error Handling&apos;, function() {
     /** @test {DB#get} */
     it(&apos;get() - should throw error if no {_id: 0} is passed&apos;, function() {
       assert.throws(function() {
         db.get();
       });
     });
     /** @test {DB#remove} */
     it(&apos;remove() - should throw error if no params is passed&apos;, function() {
       assert.throws(function() {
         db.remove();
       });
     });
     /** @test {DB#remove} */
     it(&apos;remove() - should throw error if no _id is passed&apos;, function() {
       assert.throws(function() {
         db.remove({});
       });
     });

     /** @test {DB#put} */
     it(&apos;put() - should throw error if no params is passed&apos;, function() {
       assert.throws(function() {
         db.put();
       });
     });
     /** @test {DB#put} */
     it(&apos;put() - should throw error if no _id is passed&apos;, function() {
       assert.throws(function() {
         db.put({});
       });
     });
   });
 });
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
