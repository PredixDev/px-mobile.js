<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/ds/db.js | px-mobile.js API API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="git+https://github.com/jonniespratley/px-mobilejs.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/base.js~BaseClass.html">BaseClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pxMobile">pxMobile</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/x-module.js~xModule.html">xModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">core</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/plugins.js~Plugins.html">Plugins</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/pubsub.js~PubSub.html">PubSub</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/router-history.js~RouterHistory.html">RouterHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/service-locator.js~ServiceLocator.html">ServiceLocator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/simple-router.js~SimpleRouter.html">SimpleRouter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ds</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/collection.js~Collection.html">Collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/db.js~DB.html">DB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/http.js~HTTP.html">HTTP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ds/model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">elements</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/elements/pm-page.js~pmPage.html">pmPage</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ui</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/app.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/element.js~Element.html">Element</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/elements.js~Elements.html">Elements</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/page.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/pages.js~Pages.html">Pages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/view.js~View.html">View</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ui/views.js~Views.html">Views</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/dom.js~DOM.html">DOM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/interface.js~Interface.html">Interface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/log.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dom">dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addMixin">addMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-debounce">debounce</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extend">extend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendClass">extendClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendDeep">extendDeep</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mix">mix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mixin">mixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resolveURL">resolveURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-type">type</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-uuid">uuid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$">$</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Interfaces">Interfaces</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aggregation">aggregation</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/ds/db.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;
import BaseClass from &apos;../base&apos;;
import HTTP from &apos;./http&apos;;

/**
 * @description The DB class was created to help web developers build applications that work as well offline as they do online.
 * @example
 * var db = new px.mobile.DB(&apos;db1&apos;, {
 *		baseUrl: &apos;HTTP://localhost:5984/default&apos;
 * });
 * db.get(&apos;sync-user1&apos;).then(function(resp){
 *		console.log(json);
 * });
 * @extends {BaseClass}
 * @implements {MyInterface2}
 */
export default class DB extends BaseClass {

	/**
	 * @description The constructor method that returns an instance of this DB class.
	 * @constructor
	 * @param {String} name	- The name of the instance
	 * @param {Object} options - The options object
	 * @return {DB} Instance of the DB class.
	 */
	constructor(name = &apos;db&apos;, options = {
		baseUrl: &apos;/default&apos;
	}) {
		super(name, options);


		if (!options.baseUrl) {
			//throw new Error(&apos;DB: Must provide a baseUrl&apos;);
			this.log.logApi(&apos;[DB] - Using default baseUrl - /default&apos;);
		}

		/**
		 * @type {Class} adapter - The adapter to use for all requests.
		 */
		var adapter = options.adapter || new HTTP(name, options);
		this.adapter = adapter;

		return this;
	}

	/**
	 * @description I fetch general information of the database.
	 * @example
	 * db.info().then(function(resp){
	 *		assert.equal(resp.status, 200);
	 *		assert.ok(resp.data);
	 *		assert.ok(resp.data.db_name);
	 *		assert.ok(resp.data.update_seq);
	 * }).catch(function (err) {
	 *		console.log(err);
	 * });
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	info() {
		return this.adapter.get(&apos;&apos;);
	}

	/**
	 * @description Fetch multiple documents, indexed and sorted by the _id. Deleted documents are only included if options.keys is specified.
	 * @param {Object} options - The options object
	 * @param {Boolean} options.include_docs - Include the document itself in each row in the doc field. Otherwise by default you only get the _id and _rev properties.
	 * @param {Boolean} options.conflicts - Include conflict information in the _conflicts field of a doc.
	 * @param {Boolean} options.attachments - Include attachment data as base64-encoded string.
	 * @param {String} options.startkey - Get documents with IDs in range.
	 * @param {String} options.endkey - Get documents with IDs in a certain range (inclusive/inclusive).
	 * @param {Boolean} options.inclusive_end - Include documents having an ID equal to the given options.endkey. Default: true.
	 * @param {Number} options.limit - Maximum number of documents to return.
	 * @param {Number} options.skip - Number of docs to skip before returning (warning: poor performance on IndexedDB/LevelDB!).
	 * @param {Boolean} options.descending - Reverse the order of the output documents.
	 * @param {String} options.key - Only return documents with IDs matching this string key.
	 * @param {Array} options.keys - Array of string keys to fetch in a single shot.
	 * @example
	 * db.allDocs({
	 *		limit: 5,
	 *		include_docs: true
	 * }).then(function(resp) {
	 *		expect(resp.status).toBe(200);
	 *		expect(resp.data.rows).toBeDefined();
	 *		expect(resp.data.rows.length).toBe(5);
	 * }).catch(function (err) {
	 *		console.log(err);
	 * });
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	allDocs(options) {
		this.log.logApi(&apos;allDocs&apos;, options);
		return this.adapter.get(`/_all_docs`, {
			params: options
		});
	}

	/**
	 * @description Retrieves a document, specified by docId.
	 * @example
	 * db.get(testObj._id).then(function (resp) {
	 *		expect(resp.status).toBe(200);
	 *		expect(resp.data._rev).toBeDefined();
	 * }).catch(function(err){
	 *		console.warn(err);
	 * });
	 * @param {String} docId - The id of the document
	 * @param {Object} options - The options object
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	get(docId, options) {
		this.log.logApi(&apos;get&apos;, docId);
		if (!docId) {
			throw new Error(&apos;db.get(docId) - Must provide a document _id!&apos;);
		}
		return this.adapter.get(`/${docId}`, options);
	}

	/**
	 * @description Put a document
	 * @example
	 * var doc = {
	 *		_id: &apos;test-doc1&apos;,
	 *		name: &apos;New Doc&apos;
	 * };
	 * db.put(doc).then(function(resp){
	 *		console.log(resp);
	 * }).catch(function(err){
	 *		console.warn(err);
	 * });
	 * @param {Object} doc - The document object, must have _id	for creation, and _rev for updating
	 * @param {Object} options - The options to send with the request
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	put(doc, options) {
		this.log.logApi(&apos;put&apos;, doc);
		if (!doc) {
			throw new Error(&apos;db.put(doc) - Must provide a document object!&apos;);
		}
		if (!doc._id) {
			throw new Error(&apos;db.put(doc) - Must provide a _id on the document object!&apos;);
		}
		if (doc._rev) {
			options = options || {
				params: {
					rev: doc._rev
				}
			};
		}
		return this.adapter.put(`/${doc._id}`, doc, options).then(this.adapter.parseJSON);
	}

	/**
	 * @description I handle creating a new document with a generated _id
	 * @example
	 * @param {Object} doc - A document object
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	post(doc) {
		if (!doc) {
			throw new Error(&apos;db.put(doc) - Must provide a document object!&apos;);
		}
		doc._id = this.utils.uuid();
		return this.put(doc);
	}

	/**
	 * @description I handle removing a document from the data store.
	 * @example
	 * db.get(testObj._id).then(function (resp) {
	 *		testObj._rev = resp.data._rev;
	 *		db.remove(testObj._id, testObj._rev).then(function (res) {
	 *			expect(res.status).toBe(200);
	 *		});
	 * });
	 * @description
	 * @param {String} id - The documents _id
	 * @param {String} rev - The documents _rev
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	remove(id, rev) {
		this.log.logApi(&apos;remove&apos;, {
			id: id,
			rev: rev
		});
		if (!id) {
			throw new Error(&apos;db.remove(id, rev) - Must provide a id!&apos;);
		}
		if (!rev) {
			throw new Error(&apos;db.remove(id, rev) - Must provide a rev!&apos;);
		}
		return this.adapter.delete(`/${id}`, {
			params: {
				rev: rev
			}
		}).then(this.adapter.parseJSON);
	}

	/**
	 * @description Get an attachment from the data store.
	 * @example
	 * var testAttachmentDoc = &apos;test-doc-attachment-&apos; + Date.now();
	 * db.getAttachment(testAttachmentDoc, &apos;file.html&apos;).then(function (resp) {
	 *		expect(resp.ok).toBe(true);
	 * });
	 * @param {String} id - The documents _id
	 * @param {String} attachmentId - The documents attachment name
	 * @param {String} contentType - The documents attachment Content Type
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	getAttachment(id, attachmentId, contentType) {
		this.log.logApi(&apos;getAttachment&apos;, {
			id: id,
			attachment: attachmentId
		});
		if (!id) {
			throw new Error(&apos;db.getAttachment(id, attachmentId) - Must provide a document _id!&apos;);
		}
		if (!attachmentId) {
			throw new Error(&apos;db.getAttachment(id, attachmentId) - Must provide a document attachment!&apos;);
		}
		return this.adapter.request(`${id}/${attachmentId}`, {
			method: &apos;GET&apos;,
			headers: {
				&apos;Content-Type&apos;: contentType || &apos;application/octet-stream&apos;
			}
		});
	}

	/**
	 * @description Save an attachment to the data store.
	 * @example
	 * var aFileParts = [&apos;&lt;a id=&quot;a&quot;&gt;&lt;b id=&quot;b&quot;&gt;hey!&lt;/b&gt;&lt;/a&gt;&apos;];
	 * var myBlob = new Blob(aFileParts, {
	 *		type: &apos;text/html&apos;
	 * });
	 * db.get(testAttachmentDoc).then(function (resp) {
	 *		expect(resp.ok).toBe(true);
	 *		db.saveAttachment(resp.data._id, resp.data._rev, &apos;file.html&apos;, myBlob.type, myBlob).then(function (resp) {
	 *			expect(resp.ok).toBe(true);
	 *		});
	 * });
	 * @param {String} id - The documents _id
	 * @param {String} rev - The documents _rev
	 * @param {String} filename - The documents attachment name
	 * @param {String} type - The attachment type
	 * @param {Blob} file - The actual attachment Blob
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	saveAttachment(id, rev, filename, type, file) {
		this.log.logApi(&apos;saveAttachment&apos;, file);
		return this.adapter.request(`${id}/${filename}`, {
			method: &apos;PUT&apos;,
			headers: {
				&apos;Content-Type&apos;: type || &apos;application/octet-stream&apos;
			},
			params: {
				rev: rev
			},
			body: file
		});
	}

	/**
	 * @description Bulk insert or remove documents from the data store.
	 * Create, update or delete multiple documents. The docs argument is an array of documents.
	 * If you omit an _id parameter on a given document, the database will create a new document and assign the ID for you.
	 * To update a document, you must include both an _id parameter and a _rev parameter, which should match the ID and revision of the document on which to base your updates.
	 * To delete a document, include a _deleted parameter with the value true.
	 * @example
	 * var docs = [{
	 *	 _id: &apos;test-doc-1-&apos; + Date.now(),
	 *	 name: &apos;Test Doc 1&apos;
	 * },
	 * {
	 *	 _id: &apos;test-doc-2-&apos; + Date.now(),
	 *	 name: &apos;Test Doc 2&apos;
	 * }];
	 * db.bulkDocs(docs).then(function(resp) {
	 *	 expect(resp.status).toBe(201);
	 *	 expect(resp.data.length).toBe(2);
	 * });
	 * @param {Array} docs - An array of document objects
	 * @return {Promise &lt;Response, Error&gt;} A promise that is resolved/rejected upon success/failure.
	 */
	bulkDocs(docs) {
		if (!docs) {
			throw new Error(&apos;bulkDocs - Must provide an array of documents!&apos;);
		}
		this.log.logApi(&apos;bulkDocs&apos;, docs);
		return this.adapter.post(&apos;/_bulk_docs&apos;, {
			docs: docs
		}).then(this.adapter.parseJSON);
	}

	/**
	 * @description A list of changes made to documents in the database, in the order they were made. It returns an object with the method cancel(), which you call if you don&#x2019;t want to listen to new changes anymore.
	 * It is an event emitter and will emit a &apos;change&apos; event on each document change, a &apos;complete&apos; event when all the changes have been processed, and an &apos;error&apos; event when an error occurs.
	 * In addition to the &apos;change&apos; event, any change will also emit a &apos;create&apos;, &apos;update&apos;, or &apos;delete&apos; event.
	 * @example
	 * var db = new px.mobile.DB(&apos;testdb&apos;, {baseUrl: &apos;adapter://localhost:5984/default&apos;});
	 * var changes = db.changes({
	 *		since: &apos;now&apos;,
	 *		live: true,
	 *		include_docs: true
	 * })
	 * .on(&apos;change&apos;, function(change) {
	 *		console.warn(&apos;Change&apos;, change);
	 * })
	 * .on(&apos;complete&apos;, function(info) {
	 *		console.warn(&apos;Changes completed&apos;, info);
	 * })
	 * .on(&apos;error&apos;, function (err) {
	 *		console.log(err);
	 * });
	 * changes.cancel(); // whenever you want to cancel
	 * @param {Object} options - The options to send with the changes request. All options default to false unless otherwise specified.
	 * @param {Boolean} options.live - Will emit change events for all future changes until cancelled.
	 * @param {Boolean} options.include_docs - Include the associated document with each change.
	 * @param {Boolean} options.conflicts - Include conflicts.
	 * @param {Boolean} options.attachments -Include attachments.
	 * @param {Boolean} options.binary - Return attachment data as Blobs/Buffers, instead of as base64-encoded strings.
	 * @param {Boolean} options.descending - Reverse the order of the output documents.
	 * @param {Number} options.since - Start the results from the change immediately after the given sequence number. You can also pass &apos;now&apos; if you want only new changes (when live is true).
	 * @param {Number} options.limit - Limit the number of results to this number.
	 * @param {Number} options.timeout - Request timeout (in milliseconds).
	 * @return {Object} An object with cancel() on(event) methods.
	 */
	changes(options) {
		var self = this;
		var defaults = {
			live: false,
			include_docs: false,
			conflicts: false,
			attachments: false,
			binary: false,
			descending: false,
			since: 0,
			limit: null,
			heartbeat: 1000
		};

		options = this.utils.extend(defaults, options);


		self.log.logApi(&apos;changes&apos;, options);

		//changes request
		var _fetchChanges = function() {
			self.log.logApi(&apos;_fetchChanges&apos;, options);

			return self.adapter.get(&apos;/_changes&apos;, {
				params: options
			}).then(self.adapter.parseJSON).then(function(resp) {
				options.since = resp.data.last_seq;

				if (_callbacks.change) {
					if (resp.data.results) {
						resp.data.results.forEach(function(change) {
							_callbacks.change(change);
							self.log.logApi(&apos;change&apos;, change);
						});
					}
				}

				if (resp.data.results.length === 0) {
					if (_callbacks.complete) {
						_callbacks.complete(resp);
					}
					self.log.logApi(&apos;complete&apos;, resp);
				}

				return resp;
			}).catch(function(err) {
				if (_callbacks.error) {
					_callbacks.error(err);
				}
				return err;
			});
		};

		var _callbacks = {};

		//changes feed
		var _feed = setInterval(function() {
			self.log.logApi(&apos;_feed&apos;, options);
			_fetchChanges();
		}, options.heartbeat);

		return {
			on: function(e, cb) {
				_callbacks[e] = cb;
				self.log.logApi(&apos;on&apos;, options);
				return this;
			},
			cancel: function() {
				self.log.logApi(&apos;cancel&apos;, options);
				clearInterval(_feed);
				return this;
			}
		};
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
